{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Imagen</title>
  <!-- Tu CSS personalizado -->
  <link rel="stylesheet" href="{% static 'css/gestionar_productos1.css' %}?v={{ timestamp }}">

  <style>
    .modal {
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal.hidden {
      display: none;
    }
    .modal-content {
      background-color: #fff;
      padding: 2rem;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    .modal-content .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      cursor: pointer;
    }
  </style>

</head>
<body>
  <!-- Header superior -->
  <div class="headermenu">
    <div class="hmenu">
      <img src="{% static 'diseños/imagenes/logo.png' %}" alt="logo" class="img">
      <h4>Maderas <span>Isabella</span></h4>
    </div>
  </div>
  
 <!-- Menú circular desplegable -->
 <div class="user-menu">
  <div class="user-circle" style="background-image: url('{% if user.profile_image %}{{ user.profile_image.url }}{% else %}{% static "diseños/imagenes/default-profile.png" %}{% endif %}'); background-size: cover; background-position: center;"></div>
  
  <div class="dropdown-content">
    <a href="{% url 'profile' %}">Perfil</a>
    <a href="#">Calificaciones</a>
    <a href="#">Calendario</a>
    <a href="#">Archivos privados</a>
    <a href="#">Informes</a>
    <a href="#">Preferencias</a>
    <a href="{% url 'logout' %}">Cerrar sesión</a>
  </div>
</div>
</div>

  <!-- Contenedor principal con Sidebar y Contenido -->
  <div class="main-content">
    <!-- Menú vertical (Sidebar) -->
    <div class="sidebar">
      <h2 class="title">Menú</h2>
      <div class="menu">
        <a href="{% url 'index' %}">Inicio</a>
        <a href="{% url 'gestionar_productos' %}">Galería de Publicidad</a>
        <a href="{% url 'lista_login' %}">Listado de Cuentas</a>
        <a href="{% url 'carpeta' %}">Documentos de contratación</a>
        <a href="{% url 'manage_backups' %}">Gestion de BD (backups)</a>
        <a href="{% url 'logout' %}">Cerrar Sesión</a>
      </div>
    </div>
    
    <!-- Contenido principal -->
    <div class="content">
      <h2>Gestión de Imagen</h2>
      
      <!-- Busqueda -->
      <div class="search-container">
        <input type="text" id="search-input" placeholder="Buscar imágenes...">
        <!-- Nuevo select para filtrar por tipo de madera -->
        <select id="wood-filter">
          <option value="">Todos los tipos</option>
          {% for tipo in tipos_madera %}
            <option value="{{ tipo.id }}">{{ tipo.nombre|upper }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="buttons-container">
        <a href="{% url 'index' %}" class="btn">Inicio</a>
        <button class="btn" onclick="abrirModal('modal-subir')">Subir Nueva Imagen</button>
        <a href="{% url 'inicio_publicados' %}" class="btn">Ver Publicados</a>
      </div>
      
      <h3>Imágenes en Gestión</h3>
      <!-- Se agrega un id al contenedor para que el script pueda actualizar su contenido -->
      <div id="productos-container" class="productos-container">
        {% include 'libros/productos_partial.html' %}
      </div>
    </div>
  </div>
  
  <!-- Modal de Editar Producto -->
<div id="modal-editar" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal('modal-editar')">&times;</span>
    <div id="editar-form-container">
      <!-- Este contenido se cargará vía AJAX -->
    </div>
  </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div id="modal-eliminar" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal('modal-eliminar')">&times;</span>
    <h3>¿Estás seguro que deseas eliminar el producto <span id="producto-nombre"></span>?</h3>
    <form id="form-eliminar" method="POST">
      {% csrf_token %}
      <button type="submit" class="btn-danger">Sí, eliminar</button>
      <button type="button" class="btn-secondary" onclick="cerrarModal('modal-eliminar')">Cancelar</button>
    </form>
  </div>
</div>

<!-- Modal de Subir Imagen -->
<div id="modal-subir" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal('modal-subir')">&times;</span>
    <div class="container">
      <h2>Subir Nueva Imagen</h2>
      <form id="form-producto" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <!--campos del formulario de registro de nuevo producto-->
        
        <label for="tipo_madera">Tipo de madera:</label>
        <select id="tipo_madera" name="tipo_madera" required>
          <option value="">Selecciona un tipo de madera</option>
          {% for tipo in tipos_madera %}
            <option value="{{ tipo.id }}">{{ tipo.nombre|upper }}</option>
          {% endfor %}
        </select>

        <div>
          <label for="nombre_producto">Nombre del producto:</label>
          <input type="text" id="nombre_producto" name="nombre_producto" required>
        </div>  
        <div>
          <label for="descripcion">Descripción:</label>
          <textarea id="descripcion" name="descripcion" required></textarea>
        </div>
        <div>
          <label for="precio">Precio:</label>
          <input type="number" id="precio" name="precio" step="0.00" required>
        </div>
        <div>
          <label for="imagen">Imagen:</label>
          <input type="file" id="imagen" name="imagen" required>
        </div>
        
          <button type="submit" class="btn-success">Subir Imagen</button>
      </form>

        <div class="input-group">
          
          </select>
          <button type="button" id="btn-nuevo-tipo" class="btn"> Nuevo Tipo </button>
        </div>
        

              <!-- Modal nuevo tipo madera (fuera del form-producto) -->
          <div id="modal-tipo" class="modal hidden">
            <div class="modal-content">
              <span class="close" id="btn-cancelar-tipo">&times;</span>
              <h3>Crear Nuevo Tipo de Madera</h3>
              <form id="form-tipo-madera" novalidate>
                {% csrf_token %}
                {{ tipo_form.as_p }}
                <button type="submit" class="btn-success">Crear</button>
                <button type="button" class="btn-secondary" id="btn-close-tipo">Cancelar</button>
              </form>
            </div>
          </div>
        </div>
      
    </div>
  </div>
</div>

<script>
  // Referencias
  const modalTipo = document.getElementById('modal-tipo');
  const btnNuevoTipo = document.getElementById('btn-nuevo-tipo');
  const btnCloseTipo = document.getElementById('btn-close-tipo');
  const formTipo = document.getElementById('form-tipo-madera');
  const selectTipo = document.getElementById('id_tipo_madera');

  // Abrir modal
  btnNuevoTipo.addEventListener('click', () => {
    modalTipo.classList.remove('hidden');
  });
  // Cerrar modal
  btnCloseTipo.addEventListener('click', () => {
    modalTipo.classList.add('hidden');
    formTipo.reset();
  });

  // Enviar nuevo tipo via AJAX
  formTipo.addEventListener('submit', function(e) {
    e.preventDefault();
    const data = new FormData(formTipo);
    fetch("{% url 'crear_tipo_madera_ajax' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': data.get('csrfmiddlewaretoken') },
      body: data
    })
    .then(res => res.json())
    .then(json => {
      if (json.id) {
        // Agregar nueva opción al select
        const option = document.createElement('option');
        option.value = json.id;
        option.textContent = json.nombre.toUpperCase();
        selectTipo.appendChild(option);
        selectTipo.value = json.id;
        // Cerrar
        modalTipo.classList.add('hidden');
        formTipo.reset();
      } else {
        console.error(json.errors);
        alert('Error creando tipo de madera');
      }
    });
  });
</script>

  <script src="{% static 'js/gestionar_productos.js' %}"></script>
</body>
</html>
